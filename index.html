<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weather Intensity Score — Demo</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<style>
  :root{
    --bg:#071017; --card:#0f1b22; --muted:#9aa3ad; --accent:#ff6b2d; --accent2:#ffcc00;
    --good:#2ec4b6; --warn:#ff8c42; --danger:#e64545; --extreme:#7e22ce;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,Segoe UI,system-ui,Arial; background:linear-gradient(180deg,#021016 0%, #06121a 100%); color:#e6eef0; min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:28px}
  .app{width:100%;max-width:940px}
  .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
  h1{font-size:1.1rem;margin:0;color:#dff6ef}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,select,button{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#071018;color:inherit}
  button{cursor:pointer;background:var(--accent);color:#081014;border:none;font-weight:700}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border:1px solid rgba(255,255,255,0.03);padding:18px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.6);margin-bottom:18px}
  .row{display:flex;gap:18px;align-items:center}
  .left{flex:1}
  .right{width:360px}
  .score-box{display:flex;align-items:center;gap:16px}
  .big-score{font-size:48px;font-weight:800;letter-spacing:0.5px}
  .sub{color:var(--muted);font-size:0.9rem}
  .bar-wrap{height:36px;border-radius:10px;background:#071014;border:1px solid rgba(255,255,255,0.03);padding:4px;display:flex;align-items:center}
  .bar{height:28px;border-radius:8px;flex:1;position:relative;overflow:hidden;background:linear-gradient(90deg,#2ec4b6 0%, #ffcc00 50%, #e64545 80%, #7e22ce 100%)}
  .bar-indicator{position:absolute;top:0;left:0;height:100%;background:rgba(0,0,0,0.25);backdrop-filter:blur(2px)}
  .bar-labels{display:flex;justify-content:space-between;margin-top:8px;font-size:0.85rem;color:var(--muted)}
  .spark{width:100%;height:40px}
  .meta{margin-top:10px;color:var(--muted);font-size:0.9rem}
  .footer{margin-top:12px;color:var(--muted);font-size:0.9rem}
  .chip{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-weight:600}
  .status-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;vertical-align:middle}
  .label-small{font-size:0.85rem;color:var(--muted);margin-top:6px}
  @media (max-width:920px){ .right{width:100%} .row{flex-direction:column;align-items:stretch} .score-box{justify-content:space-between} .big-score{font-size:36px} }
</style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1>Weather Intensity Score — Demo</h1>
      <div class="controls">
        <input id="labelInput" placeholder="Region name (optional)" style="min-width:200px" />
        <input id="latInput" placeholder="Latitude" value="59.4370" style="width:110px" />
        <input id="lonInput" placeholder="Longitude" value="24.7536" style="width:110px" />
        <span id="countdown" style="font-size:0.85rem;color:#9aa3ad;margin-left:8px;">Next update in 15:00</span>
      </div>
    </div>

    <!-- Scoreboard A -->
    <div class="card" role="region" aria-label="Weather intensity primary">
      <div class="row">
        <div class="left">
          <div class="score-box">
            <div>
              <div class="big-score" id="scoreValA">—</div>
              <div class="sub" id="scoreLabelA">Loading…</div>
            </div>
            <div style="flex:1">
              <div class="bar-wrap" aria-hidden="true">
                <div class="bar" id="spectrumBarA">
                  <div class="bar-indicator" id="barIndicatorA" style="width:0%"></div>
                </div>
              </div>
              <div class="bar-labels">
                <div>Quiet</div>
                <div>Active</div>
                <div>Extreme</div>
              </div>
            </div>
          </div>

          <div class="meta" id="metaTextA">—</div>
        </div>

        <div class="right">
          <canvas id="sparkA" class="spark" width="360" height="40" style="background:transparent;border-radius:6px"></canvas>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <div class="chip" id="windChipA">Wind: — km/h</div>
            <div another="chip" id="presChipA">Pressure: — hPa</div>
            <div class="chip" id="precipChipA">Precip: — mm</div>
          </div>
        </div>
      </div>
      <div class="footer">Source(s): Open-Meteo + ZoomEarth + Meteologix (if available). Auto-update every 15 minutes.</div>
    </div>

    <!-- Scoreboard B -->
    <div class="card" role="region" aria-label="Weather intensity box region">
      <div style="margin-bottom:12px"><strong>Box Tracker</strong> <span class="label-small">Fixed box: top-left lat 62.58 lon 49.42 — bottom-right lat 37.12 lon 37.28</span></div>
      <div class="row">
        <div class="left">
          <div class="score-box">
            <div>
              <div class="big-score" id="scoreValB">—</div>
              <div class="sub" id="scoreLabelB">Loading…</div>
            </div>
            <div style="flex:1">
              <div class="bar-wrap">
                <div class="bar" id="spectrumBarB">
                  <div class="bar-indicator" id="barIndicatorB" style="width:0%"></div>
                </div>
              </div>
              <div class="bar-labels">
                <div>Quiet</div>
                <div>Active</div>
                <div>Extreme</div>
              </div>
            </div>
          </div>
          <div class="meta" id="metaTextB">—</div>
        </div>
        <div class="right">
          <canvas id="sparkB" class="spark" width="360" height="40" style="background:transparent;border-radius:6px"></canvas>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <div class="chip" id="windChipB">Wind: — km/h</div>
            <div class="chip" id="presChipB">Pressure: — hPa</div>
            <div class="chip" id="precipChipB">Precip: — mm</div>
          </div>
        </div>
      </div>
      <div class="footer">Box score aggregates across bounding box. Extra sources best-effort.</div>
    </div>

  </div>

<script>
/* CONFIG */
const CONFIG = {
  OPEN_METEO_BASE: 'https://api.open-meteo.com/v1/forecast',
  P_REF: 1015,
  WEIGHT_PRESSURE: 1.8,
  WEIGHT_WIND: 2.8,
  WEIGHT_PRECIP: 1.4,
  UPDATE_MINUTES: 15,
  SOURCE_WEIGHTS: { open: 0.6, zoom: 0.25, stations: 0.15 }
};

/* Additional API credentials / endpoints */
const ZOOM_EARTH_ENDPOINT = 'https://api.zoom.earth/...'; // You must fill correct endpoint
const METEOLOGIX_API_KEY = 'iJ7qDsFuV5j0ew_vDO76BT4Bo4yMILwhZF25a8mBap4A2H8J6zIG5kdJLpz7QtxcipY5xRe_btTtZTlBp33S1cZCx2TtiSz-nMihR_tWuUSAjV_9HIzQF-bn-UgSP-9w';
const METEOLOGIX_ENDPOINT = 'https://api.meteologix.com/v1/observations/latest'; // example

/* DOM refs for both A and B */
const controls = {
  latInput: document.getElementById('latInput'),
  lonInput: document.getElementById('lonInput'),
  labelInput: document.getElementById('labelInput'),
  refreshBtn: document.getElementById('refreshBtn')
};

const UI = {
  A: {
    scoreVal: document.getElementById('scoreValA'),
    scoreLabel: document.getElementById('scoreLabelA'),
    meta: document.getElementById('metaTextA'),
    wind: document.getElementById('windChipA'),
    pres: document.getElementById('presChipA'),
    precip: document.getElementById('precipChipA'),
    barIndicator: document.getElementById('barIndicatorA'),
    sparkCanvas: document.getElementById('sparkA'),
    sparkCtx: document.getElementById('sparkA').getContext('2d'),
    history: []
  },
  B: {
    scoreVal: document.getElementById('scoreValB'),
    scoreLabel: document.getElementById('scoreLabelB'),
    meta: document.getElementById('metaTextB'),
    wind: document.getElementById('windChipB'),
    pres: document.getElementById('presChipB'),
    precip: document.getElementById('precipChipB'),
    barIndicator: document.getElementById('barIndicatorB'),
    sparkCanvas: document.getElementById('sparkB'),
    sparkCtx: document.getElementById('sparkB').getContext('2d'),
    history: []
  }
};

/* Fixed box for B */
const BOX = {
  topLeft: { lat: 62.58, lon: 49.42 },
  bottomRight: { lat: 37.12, lon: 37.28 },
  stepsLat: 3,
  stepsLon: 3
};

/* categories */
const CATEGORIES = [
  {name:'Quiet', min:0, max:10, color:'rgba(46,196,182,0.95)'},
  {name:'Minor', min:10, max:25, color:'#6fe5c6'},
  {name:'Moderate', min:25, max:40, color:'#ffe88c'},
  {name:'Active', min:40, max:80, color:'rgba(255,140,66,0.95)'},
  {name:'Severe', min:80, max:120, color:'rgba(230,69,69,0.95)'},
  {name:'Extreme', min:120, max:200, color:'rgba(126,34,206,0.95)'}
];

/* Helpers */
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function categoryFor(score){
  for (let i=CATEGORIES.length-1;i>=0;i--){
    if (score >= CATEGORIES[i].min) return CATEGORIES[i];
  }
  return CATEGORIES[0];
}

/* Fetch functions */
async function fetchOpenMeteo(lat, lon){
  const url = new URL(CONFIG.OPEN_METEO_BASE);
  url.searchParams.set('latitude', lat);
  url.searchParams.set('longitude', lon);
  url.searchParams.set('hourly', 'pressure_msl,windspeed_10m,precipitation');
  url.searchParams.set('timezone','UTC');
  const resp = await fetch(url.toString(), {cache:'no-cache'});
  if (!resp.ok) throw new Error('Open-Meteo error '+resp.status);
  const d = await resp.json();
  const times = d.hourly.time;
  if (!times || !times.length) throw new Error('No hourly data');
  const now = new Date();
  const nowIso = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), now.getUTCHours())).toISOString().slice(0,13)+':00';
  let idx = times.indexOf(nowIso);
  if (idx < 0) idx = times.length - 1;
  const pressure = d.hourly.pressure_msl[idx];
  const wind_m_s = d.hourly.windspeed_10m[idx];
  const precip = d.hourly.precipitation[idx];
  return {
    source: 'open',
    pressure_hpa: pressure != null ? Number(pressure) : null,
    wind_kmh: wind_m_s != null ? Number(wind_m_s)*3.6 : null,
    precip_mm_hr: precip != null ? Number(precip) : 0
  };
}

async function fetchZoomEarth(lat, lon){
  try {
    const url = `${ZOOM_EARTH_ENDPOINT}?lat=${lat}&lon=${lon}`;
    const resp = await fetch(url, {cache:'no-cache'});
    if (!resp.ok) throw new Error('ZoomEarth API failed');
    const d = await resp.json();
    // assuming d has fields: pressure, wind, precip
    return {
      source: 'zoom',
      pressure_hpa: d.pressure != null ? Number(d.pressure) : null,
      wind_kmh: d.wind != null ? Number(d.wind) : null,
      precip_mm_hr: d.precip != null ? Number(d.precip) : 0
    };
  } catch(e){
    console.warn('ZoomEarth fetch failed', e);
    return null;
  }
}

async function fetchMeteologix(lat, lon){
  try {
    const url = new URL(METEOLOGIX_ENDPOINT);
    url.searchParams.set('lat', lat);
    url.searchParams.set('lon', lon);
    url.searchParams.set('apikey', METEOLOGIX_API_KEY);
    const resp = await fetch(url.toString(), {cache:'no-cache'});
    if (!resp.ok) throw new Error('Meteologix API failed '+resp.status);
    const d = await resp.json();
    // assume d has structure {wind, pressure_msl, precipitation_rate_mm_h}
    return {
      source: 'stations',
      pressure_hpa: d.pressure_msl != null ? Number(d.pressure_msl) : null,
      wind_kmh: d.wind != null ? Number(d.wind) : null,
      precip_mm_hr: d.precipitation_rate_mm_h != null ? Number(d.precipitation_rate_mm_h) : 0
    };
  } catch(e){
    console.warn('Meteologix fetch failed', e);
    return null;
  }
}

/* Score computations */
function computeRawScoreSingle(measure){
  const p = measure.pressure_hpa;
  const w = measure.wind_kmh;
  const pr = measure.precip_mm_hr;
  const pterm = p != null ? Math.max(0, (CONFIG.P_REF - p)) * CONFIG.WEIGHT_PRESSURE : 0;
  const wterm = w != null ? w * CONFIG.WEIGHT_WIND : 0;
  const prterm = pr != null ? pr * CONFIG.WEIGHT_PRECIP : 0;
  return pterm + wterm + prterm;
}

function blendSources(sources){
  const weights = CONFIG.SOURCE_WEIGHTS;
  const avail = sources.filter(s=>s);
  if (avail.length === 0) return {score:0, details:[]};
  let sumW = 0; avail.forEach(s=> sumW += weights[s.source] || 0);
  if (sumW === 0){
    avail.forEach(s=> s._w = 1/avail.length);
  } else {
    avail.forEach(s=> s._w = (weights[s.source] || 0)/sumW);
  }
  let final = 0; const details = [];
  avail.forEach(s=>{
    const raw = computeRawScoreSingle(s);
    final += raw * s._w;
    details.push({source:s.source, raw, weight: s._w});
  });
  return {score: +final.toFixed(2), details};
}

/* Combine measures for display */
function combineMeasures(sources){
  const avail = sources.filter(s=>s);
  if (avail.length === 0) return {pressure_hpa:null, wind_kmh:null, precip_mm_hr:0};
  let sumW = 0; avail.forEach(s=> sumW += CONFIG.SOURCE_WEIGHTS[s.source] || 0);
  if (sumW === 0){
    avail.forEach(s=> s._w = 1/avail.length);
  } else {
    avail.forEach(s=> s._w = (CONFIG.SOURCE_WEIGHTS[s.source] || 0)/sumW);
  }
  const out = {pressure_hpa:0, wind_kmh:0, precip_mm_hr:0};
  let countP=0, countW=0;
  avail.forEach(s=>{
    if (s.pressure_hpa != null){ out.pressure_hpa += s.pressure_hpa * s._w; countP++; }
    if (s.wind_kmh != null){ out.wind_kmh += s.wind_kmh * s._w; countW++; }
    out.precip_mm_hr += s.precip_mm_hr * s._w;
  });
  if (countP === 0) out.pressure_hpa = null;
  if (countW === 0) out.wind_kmh = null;
  return out;
}

/* Render outcome */
function render(ui, score, measures){
  ui.scoreVal.textContent = score.toFixed(2);
  const cat = categoryFor(score);
  ui.scoreLabel.innerHTML = `<span class="status-dot" style="background:${cat.color}"></span> ${cat.name}`;
  const regionName = controls.labelInput.value.trim() ? ('Region: '+controls.labelInput.value.trim()) : '';
  ui.meta.textContent = `${regionName} • last update: ${new Date().toLocaleString()}`;
  ui.wind.textContent = measures.wind_kmh != null ? `Wind: ${measures.wind_kmh.toFixed(0)} km/h` : 'Wind: —';
  ui.pres.textContent = measures.pressure_hpa != null ? `Pressure: ${measures.pressure_hpa.toFixed(0)} hPa` : 'Pressure: —';
  ui.precip.textContent = `Precip: ${measures.precip_mm_hr != null ? measures.precip_mm_hr.toFixed(1) : '0.0'} mm`;
  const pct = Math.min(100, Math.round((score/200)*100));
  ui.barIndicator.style.width = pct + '%';
  ui.barIndicator.style.background = cat.color;
  ui.history.push(score);
  if (ui.history.length > 24) ui.history.shift();
  drawSpark(ui.sparkCtx, ui.sparkCanvas, ui.history);
}

  function drawSpark(ctx, canvas, data){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (data.length < 2) return;
  const max = Math.max(...data);
  const min = Math.min(...data);
  ctx.beginPath();
  for (let i=0;i<data.length;i++){
    const x = (i/(data.length-1))*canvas.width;
    const y = canvas.height - ((data[i]-min)/(max-min+1e-6))*canvas.height;
    if (i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.strokeStyle = '#ffcc00';
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.fillStyle = 'rgba(255,204,0,0.15)';
  ctx.lineTo(canvas.width,canvas.height);
  ctx.lineTo(0,canvas.height);
  ctx.closePath();
  ctx.fill();
}


async function updateA(){
  const lat = parseFloat(controls.latInput.value);
  const lon = parseFloat(controls.lonInput.value);
  if (isNaN(lat) || isNaN(lon)) return;
  const open = await fetchOpenMeteo(lat, lon);
  const zoom = await fetchZoomEarth(lat, lon);
  const station = await fetchMeteologix(lat, lon);
  const blend = blendSources([open, zoom, station]);
  const measures = combineMeasures([open, zoom, station]);
  render(UI.A, blend.score, measures);
}

async function updateB(){
  const lat1 = BOX.topLeft.lat, lon1 = BOX.topLeft.lon;
  const lat2 = BOX.bottomRight.lat, lon2 = BOX.bottomRight.lon;
  const stepsLat = BOX.stepsLat, stepsLon = BOX.stepsLon;
  const coords = [];
  for (let i=0;i<stepsLat;i++){
    const fLat = i/(stepsLat-1);
    for (let j=0;j<stepsLon;j++){
      const fLon = j/(stepsLon-1);
      coords.push({lat: lat1 + (lat2-lat1)*fLat, lon: lon1 + (lon2-lon1)*fLon});
    }
  }
  const results = await Promise.all(coords.map(c => fetchOpenMeteo(c.lat, c.lon)));
  const openAvg = averageMeasures(results.filter(r=>r));
  const zoom = await fetchZoomEarth((lat1+lat2)/2, (lon1+lon2)/2);
  const station = await fetchMeteologix((lat1+lat2)/2, (lon1+lon2)/2);
  const blend = blendSources([openAvg ? {...openAvg, source:'open'} : null, zoom, station]);
  const measures = combineMeasures([openAvg ? {...openAvg, source:'open'} : null, zoom, station]);
  render(UI.B, blend.score, measures);
}

function averageMeasures(list){
  if (!list.length) return null;
  const sum = {pressure_hpa:0, wind_kmh:0, precip_mm_hr:0};
  let countP=0, countW=0, countPr=0;
  list.forEach(l=>{
    if (l.pressure_hpa != null){ sum.pressure_hpa += l.pressure_hpa; countP++; }
    if (l.wind_kmh != null){ sum.wind_kmh += l.wind_kmh; countW++; }
    sum.precip_mm_hr += l.precip_mm_hr; countPr++;
  });
  return {
    source: 'open',
    pressure_hpa: countP? sum.pressure_hpa/countP : null,
    wind_kmh: countW? sum.wind_kmh/countW : null,
    precip_mm_hr: sum.precip_mm_hr/countPr
  };
}

controls.refreshBtn.addEventListener('click', ()=>{ updateA(); updateB(); });

  /* countdown timer */
let remaining = CONFIG.UPDATE_MINUTES * 60;
const countdownEl = document.getElementById('countdown');

function updateCountdown() {
  if (!countdownEl) return;
  const m = Math.floor(remaining / 60);
  const s = remaining % 60;
  countdownEl.textContent = `Next update in ${m}:${s.toString().padStart(2,'0')}`;
  if (remaining > 0) {
    remaining--;
  } else {
    remaining = CONFIG.UPDATE_MINUTES * 60;
    updateA();
    updateB();
  }

  // color fade (red when under 1 min)
  if (remaining < 60) countdownEl.style.color = "#e64545";
  else countdownEl.style.color = "#9aa3ad";
}

setInterval(updateCountdown, 1000);


</script>
</body>
</html>
